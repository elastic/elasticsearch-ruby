<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Bulk and Scroll helpers | Elasticsearch Ruby Client | Elastic</title>
<meta class="elastic" name="content" content="Bulk and Scroll helpers | Elasticsearch Ruby Client">

<link rel="home" href="index.html" title="Elasticsearch Ruby Client"/>
<link rel="up" href="client-helpers.html" title="Client helpers"/>
<link rel="prev" href="client-helpers.html" title="Client helpers"/>
<link rel="next" href="esql.html" title="ES|QL in the Ruby client"/>
<meta class="elastic" name="product_version" content=""/>
<meta class="elastic" name="product_name" content=""/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/"/>
<meta name="DC.subject" content=""/>
<meta name="DC.identifier" content=""/>
</head>
<body>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elasticsearch Ruby Client</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="client-helpers.html">Client helpers</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="client-helpers.html">« Client helpers</a>
</span>
<span class="next">
<a href="esql.html">ES|QL in the Ruby client »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="Helpers"></a>Bulk and Scroll helpers<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch-ruby/edit/master/docs/helpers/bulk-scroll.asciidoc">edit</a></h2>
</div></div></div>
<p>The Elasticsearch Ruby client includes Bulk and Scroll helpers for working with results more efficiently.</p>
<h4><a id="_bulk_helper"></a>Bulk helper<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch-ruby/edit/master/docs/helpers/bulk-scroll.asciidoc">edit</a></h4>
<p>The Bulk API in Elasticsearch allows you to perform multiple indexing or deletion operations through a single API call, resulting in reduced overhead and improved indexing speed. The actions are specified in the request body using a newline delimited JSON (NDJSON) structure. In the Elasticsearch Ruby client, the <code class="literal">bulk</code> method supports several data structures as a parameter. You can use the Bulk API in an idiomatic way without concerns about payload formatting. Refer to <a class="xref" href="examples.html#ex-bulk" title="Bulk requests">Bulk requests</a> for more information.</p>
<p>The BulkHelper provides a better developer experience when using the Bulk API. At its simplest, you can send it a collection of hashes in an array, and it will bulk ingest them into Elasticsearch.</p>
<p>To use the BulkHelper, require it in your code:</p>
<div class="pre_wrapper lang-ruby">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby">require 'elasticsearch/helpers/bulk_helper'</pre>
</div>
<p>Instantiate a BulkHelper with a client, and an index:</p>
<div class="pre_wrapper lang-ruby">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby">client = Elasticsearch::Client.new
bulk_helper = Elasticsearch::Helpers::BulkHelper.new(client, index)</pre>
</div>
<p>This helper works on the index you pass in during initialization, but you can change the index at any time in your code:</p>
<div class="pre_wrapper lang-ruby">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby">bulk_helper.index = 'new_index'</pre>
</div>
<p>If you want to index a collection of documents, use the <code class="literal">ingest</code> method:</p>
<div class="pre_wrapper lang-ruby">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby">documents = [
  { name: 'document1', date: '2024-05-16' },
  { name: 'document2', date: '2023-12-19' },
  { name: 'document3', date: '2024-07-07' }
]
bulk_helper.ingest(documents)</pre>
</div>
<p>If you&#8217;re ingesting a large set of data and want to separate the documents into smaller pieces before sending them to Elasticsearch, use the <code class="literal">slice</code> parameter.</p>
<div class="pre_wrapper lang-ruby">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby">bulk_helper.ingest(documents, { slice: 2 })</pre>
</div>
<p>This way the data will be sent in two different bulk requests.</p>
<p>You can also include the parameters you would send to the Bulk API either in the query parameters or in the request body. The method signature is <code class="literal">ingest(docs, params = {}, body = {}, &amp;block)</code>. Additionally, the method can be called with a block, that will provide access to the response object received from calling the Bulk API and the documents sent in the request:</p>
<div class="pre_wrapper lang-ruby">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby">helper.ingest(documents) { |_, docs| puts "Ingested #{docs.count} documents" }</pre>
</div>
<p>You can update and delete documents with the BulkHelper too. To delete a set of documents, you can send an array of document ids:</p>
<div class="pre_wrapper lang-ruby">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby">ids = ['shm0I4gB6LpJd9ljO9mY', 'sxm0I4gB6LpJd9ljO9mY', 'tBm0I4gB6LpJd9ljO9mY', 'tRm0I4gB6LpJd9ljO9mY', 'thm0I4gB6LpJd9ljO9mY', 'txm0I4gB6LpJd9ljO9mY', 'uBm0I4gB6LpJd9ljO9mY', 'uRm0I4gB6LpJd9ljO9mY', 'uhm0I4gB6LpJd9ljO9mY', 'uxm0I4gB6LpJd9ljO9mY']
helper.delete(ids)</pre>
</div>
<p>To update documents, you can send the array of documents with their respective ids:</p>
<div class="pre_wrapper lang-ruby">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby">documents = [
  {name: 'updated name 1', id: 'AxkFJYgB6LpJd9ljOtr7'},
  {name: 'updated name 2', id: 'BBkFJYgB6LpJd9ljOtr7'}
]
helper.update(documents)</pre>
</div>
<h5><a id="_ingest_a_json_file"></a>Ingest a JSON file<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch-ruby/edit/master/docs/helpers/bulk-scroll.asciidoc">edit</a></h5>
<p><code class="literal">BulkHelper</code> also provides a helper to ingest data straight from a JSON file. By giving a file path as an input, the helper will parse and ingest the documents in the file:</p>
<div class="pre_wrapper lang-ruby">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby">file_path = './data.json'
helper.ingest_json(file_path)</pre>
</div>
<p>In cases where the array of data you want to ingest is not necessarily in the root of the JSON file, you can provide the keys to access the data, for example given the following JSON file:</p>
<div class="pre_wrapper lang-json">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-json">{
  "field": "value",
  "status": 200,
  "data": {
    "items": [
      {
        "name": "Item 1",
        (...)
      },
      {
      (...)
    ]
  }
}</pre>
</div>
<p>The following is an example of the Ruby code to ingest the documents in the JSON above:</p>
<div class="pre_wrapper lang-ruby">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby">bulk_helper.ingest_json(file_path, { keys: ['data', 'items'] })</pre>
</div>
<h4><a id="_scroll_helper"></a>Scroll helper<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch-ruby/edit/master/docs/helpers/bulk-scroll.asciidoc">edit</a></h4>
<p>This helper provides an easy way to get results from a Scroll.</p>
<p>To use the ScrollHelper, require it in your code:</p>
<div class="pre_wrapper lang-ruby">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby">require 'elasticsearch/helpers/scroll_helper'</pre>
</div>
<p>Instantiate a ScrollHelper with a client, an index, and a body (with the scroll API parameters) which will be used in every following scroll request:</p>
<div class="pre_wrapper lang-ruby">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby">client = Elasticsearch::Client.new
scroll_helper = Elasticsearch::Helpers::ScrollHelper.new(client, index, body)</pre>
</div>
<p>There are two ways to get the results from a scroll using the helper.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>You can iterate over a scroll using the methods in <code class="literal">Enumerable</code> such as <code class="literal">each</code> and <code class="literal">map</code>:</p>
<div class="pre_wrapper lang-ruby">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby">scroll_helper.each do |item|
  puts item
end</pre>
</div>
</li>
<li class="listitem">
<p>You can fetch results by page, with the <code class="literal">results</code> function:</p>
<div class="pre_wrapper lang-ruby">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby">my_documents = []
while !(documents = scroll_helper.results).empty?
  my_documents &lt;&lt; documents
end
scroll_helper.clear</pre>
</div>
</li>
</ol>
</div>
</div>
<div class="navfooter">
<span class="prev">
<a href="client-helpers.html">« Client helpers</a>
</span>
<span class="next">
<a href="esql.html">ES|QL in the Ruby client »</a>
</span>
</div>
</div>
</body>
</html>
