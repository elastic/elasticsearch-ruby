<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Using OpenTelemetry | Elasticsearch Ruby Client | Elastic</title>
<meta class="elastic" name="content" content="Using OpenTelemetry | Elasticsearch Ruby Client">

<link rel="home" href="index.html" title="Elasticsearch Ruby Client"/>
<link rel="up" href="integrations.html" title="Integrations"/>
<link rel="prev" href="api.html" title="Elasticsearch API"/>
<link rel="next" href="ecs.html" title="Elastic Common Schema (ECS)"/>
<meta class="elastic" name="product_version" content=""/>
<meta class="elastic" name="product_name" content=""/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/"/>
<meta name="DC.subject" content=""/>
<meta name="DC.identifier" content=""/>
</head>
<body>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elasticsearch Ruby Client</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="integrations.html">Integrations</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="api.html">« Elasticsearch API</a>
</span>
<span class="next">
<a href="ecs.html">Elastic Common Schema (ECS) »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="opentelemetry"></a>Using OpenTelemetry<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch-ruby/edit/master/docs/open-telemetry.asciidoc">edit</a></h2>
</div></div></div>
<p>You can use <a href="https://opentelemetry.io/" class="ulink" target="_top">OpenTelemetry</a> to monitor the performance and behavior of your Elasticsearch requests through the Ruby Client.
The Ruby Client comes with built-in OpenTelemetry instrumentation that emits <a href="https://www.elastic.co/guide/en/apm/guide/current/apm-distributed-tracing.html" class="ulink" target="_top">distributed tracing spans</a> by default.
With that, applications <a href="https://opentelemetry.io/docs/instrumentation/ruby/manual/" class="ulink" target="_top">instrumented with OpenTelemetry</a> or using the <a href="https://opentelemetry.io/docs/instrumentation/ruby/automatic/" class="ulink" target="_top">OpenTelemetry Ruby SDK</a> are inherently enriched with additional spans that contain insightful information about the execution of the Elasticsearch requests.</p>
<p>The native instrumentation in the Ruby Client follows the <a href="https://opentelemetry.io/docs/specs/semconv/database/elasticsearch/" class="ulink" target="_top">OpenTelemetry Semantic Conventions for Elasticsearch</a>. In particular, the instrumentation in the client covers the logical layer of Elasticsearch requests. A single span per request is created that is processed by the service through the Ruby Client. The following image shows a trace that records the handling of two different Elasticsearch requests: a <code class="literal">ping</code> request and a <code class="literal">search</code> request.</p>
<div class="imageblock text-center screenshot">
<div class="content">
<img src="images/otel-waterfall-without-http.png" alt="Distributed trace with Elasticsearch spans">
</div>
</div>
<p>Usually, OpenTelemetry auto-instrumentation modules come with instrumentation support for HTTP-level communication. In this case, in addition to the logical Elasticsearch client requests, spans will be captured for the physical HTTP requests emitted by the client. The following image shows a trace with both, Elasticsearch spans (in blue) and the corresponding HTTP-level spans (in red):</p>
<div class="imageblock text-center screenshot">
<div class="content">
<img src="images/otel-waterfall-with-http.png" alt="Distributed trace with Elasticsearch spans">
</div>
</div>
<p>Advanced Ruby Client behavior such as nodes round-robin and request retries are revealed through the combination of logical Elasticsearch spans and the physical HTTP spans. The following example shows a <code class="literal">search</code> request in a scenario with two nodes:</p>
<div class="imageblock text-center screenshot">
<div class="content">
<img src="images/otel-waterfall-retry.png" alt="Distributed trace with Elasticsearch spans">
</div>
</div>
<p>The first node is unavailable and results in an HTTP error, while the retry to the second node succeeds. Both HTTP requests are subsumed by the logical Elasticsearch request span (in blue).</p>
<h4><a id="_setup_the_opentelemetry_instrumentation"></a>Setup the OpenTelemetry instrumentation<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch-ruby/edit/master/docs/open-telemetry.asciidoc">edit</a></h4>
<p>When using the <a href="https://opentelemetry.io/docs/instrumentation/ruby/manual" class="ulink" target="_top">OpenTelemetry Ruby SDK manually</a> or using the <a href="https://opentelemetry.io/docs/instrumentation/ruby/automatic/" class="ulink" target="_top">OpenTelemetry Ruby Auto-Instrumentations</a>, the Ruby Client&#8217;s OpenTelemetry instrumentation is enabled by default and uses the global OpenTelemetry SDK with the global tracer provider. You can provide a tracer provider via the Ruby Client configuration option <code class="literal">opentelemetry_tracer_provider</code> when instantiating the client. This is sometimes useful for testing or other specific use cases.</p>
<div class="pre_wrapper lang-ruby">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-ruby">client = Elasticsearch::Client.new(
  cloud_id: '&lt;CloudID&gt;',
  api_key: '&lt;ApiKey&gt;',
  opentelemetry_tracer_provider: tracer_provider
)</pre>
</div>
<h4><a id="_configuring_the_opentelemetry_instrumentation"></a>Configuring the OpenTelemetry instrumentation<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch-ruby/edit/master/docs/open-telemetry.asciidoc">edit</a></h4>
<p>You can configure the OpenTelemetry instrumentation through Environment Variables.
The following configuration options are available.</p>
<h5><a id="opentelemetry-config-enable"></a>Enable / Disable the OpenTelemetry instrumentation<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch-ruby/edit/master/docs/open-telemetry.asciidoc">edit</a></h5>
<p>With this configuration option you can enable (default) or disable the built-in OpenTelemetry instrumentation.</p>
<p><span class="strong strong"><strong>Default:</strong></span> <code class="literal">true</code></p>
<div class="informaltable">
<table border="1" cellpadding="4px">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
</colgroup>
<tbody>
<tr>
<td align="left" valign="top"><p>Environment Variable</p></td>
<td align="left" valign="top"><p><code class="literal">OTEL_RUBY_INSTRUMENTATION_ELASTICSEARCH_ENABLED</code></p></td>
</tr>
</tbody>
</table>
</div>
<h5><a id="_capture_search_request_bodies"></a>Capture search request bodies<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch-ruby/edit/master/docs/open-telemetry.asciidoc">edit</a></h5>
<p>Per default, the built-in OpenTelemetry instrumentation does not capture request bodies due to data privacy considerations. You can use this option to enable capturing of search queries from the request bodies of Elasticsearch search requests in case you wish to gather this information regardless. The options are to capture the raw search query, sanitize the query with a default list of sensitive keys, or not capture it at all.</p>
<p><span class="strong strong"><strong>Default:</strong></span> <code class="literal">omit</code></p>
<p><span class="strong strong"><strong>Valid Options:</strong></span> <code class="literal">omit</code>, <code class="literal">sanitize</code>, <code class="literal">raw</code></p>
<div class="informaltable">
<table border="1" cellpadding="4px">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
</colgroup>
<tbody>
<tr>
<td align="left" valign="top"><p>Environment Variable</p></td>
<td align="left" valign="top"><p><code class="literal">OTEL_RUBY_INSTRUMENTATION_ELASTICSEARCH_CAPTURE_SEARCH_QUERY</code></p></td>
</tr>
</tbody>
</table>
</div>
<h5><a id="_sanitize_the_elasticsearch_search_request_body"></a>Sanitize the Elasticsearch search request body<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch-ruby/edit/master/docs/open-telemetry.asciidoc">edit</a></h5>
<p>You can configure the list of keys whose values are redacted when the search query is captured. Values must be comma-separated.
Note in v8.3.0 and v8.3.1, the environment variable <code class="literal">OTEL_INSTRUMENTATION_ELASTICSEARCH_CAPTURE_SEARCH_QUERY</code> was available
but is now deprecated in favor of the environment variable including <code class="literal">RUBY</code>.</p>
<p><span class="strong strong"><strong>Default:</strong></span> <code class="literal">nil</code></p>
<div class="informaltable">
<table border="1" cellpadding="4px">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
</colgroup>
<tbody>
<tr>
<td align="left" valign="top"><p>Environment Variable</p></td>
<td align="left" valign="top"><p><code class="literal">OTEL_RUBY_INSTRUMENTATION_ELASTICSEARCH_SEARCH_QUERY_SANITIZE_KEYS</code></p></td>
</tr>
</tbody>
</table>
</div>
<p>Example:</p>
<div class="pre_wrapper lang-bash">
<div class="console_code_copy" title="Copy to clipboard"></div>
<pre class="programlisting prettyprint lang-bash">OTEL_RUBY_INSTRUMENTATION_ELASTICSEARCH_SEARCH_QUERY_SANITIZE_KEYS='sensitive-key,other-sensitive-key'</pre>
</div>
<h4><a id="_overhead"></a>Overhead<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch-ruby/edit/master/docs/open-telemetry.asciidoc">edit</a></h4>
<p>The OpenTelemetry instrumentation (as any other monitoring approach) may come with a slight overhead on CPU, memory, and/or latency. The overhead may only occur when the instrumentation is enabled (default) and an OpenTelemetry SDK is active in the target application. When the instrumentation is disabled or no OpenTelemetry SDK is active within the target application, monitoring overhead is not expected when using the client.</p>
<p>Even in cases where the instrumentation is enabled and is actively used (by an OpenTelemetry SDK), the overhead is minimal and negligible in the vast majority of cases. In edge cases where there is a noticeable overhead, the <a class="xref" href="opentelemetry.html#opentelemetry-config-enable" title="Enable / Disable the OpenTelemetry instrumentation">instrumentation can be explicitly disabled</a> to eliminate any potential impact on performance.</p>
</div>
<div class="navfooter">
<span class="prev">
<a href="api.html">« Elasticsearch API</a>
</span>
<span class="next">
<a href="ecs.html">Elastic Common Schema (ECS) »</a>
</span>
</div>
</div>
</body>
</html>
